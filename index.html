<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ectomorph Guide V4: Misi 40kg + Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked for Markdown parsing in AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
            color: #1F2937;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
        }

        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar {
            width: 6px;
        }
        .scroller::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .scroller::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .scroller::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Markdown Styles for AI Response */
        .prose h3 { font-weight: bold; font-size: 1.1em; margin-top: 1em; color: #ea580c; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin: 0.5em 0; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { color: #1f2937; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #ea580c;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-orange-600">Ecto<span class="text-gray-800">Guide</span> <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full ml-2">V4.0 AI ‚ú®</span></span>
                </div>
                <div class="hidden md:flex space-x-4 items-center">
                    <a href="#ai-assistant" class="text-purple-600 hover:text-purple-800 px-3 py-2 rounded-md text-sm font-bold bg-purple-50 border border-purple-100">‚ú® Asisten AI</a>
                    <a href="#kalori" class="text-gray-600 hover:text-green-600 px-3 py-2 rounded-md text-sm font-medium">Cek Makanan</a>
                    <a href="#tools" class="text-gray-600 hover:text-orange-600 px-3 py-2 rounded-md text-sm font-medium">Tools</a>
                    <a href="#latihan" class="text-gray-600 hover:text-orange-600 px-3 py-2 rounded-md text-sm font-medium">Latihan</a>
                </div>
                <div class="flex md:hidden items-center">
                    <button id="mobile-menu-btn" class="text-gray-600 text-2xl px-2">‚ò∞</button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100">
            <a href="#ai-assistant" class="block px-4 py-2 text-purple-600 font-bold bg-purple-50">‚ú® Asisten AI</a>
            <a href="#kalori" class="block px-4 py-2 text-gray-600 hover:bg-gray-50">Cek Makanan Indo</a>
            <a href="#tools" class="block px-4 py-2 text-gray-600 hover:bg-gray-50">Tools & Tracker</a>
            <a href="#latihan" class="block px-4 py-2 text-gray-600 hover:bg-gray-50">Latihan</a>
        </div>
    </nav>

    <!-- Hero -->
    <header class="bg-gradient-to-b from-orange-50 to-white border-b border-orange-100">
        <div class="max-w-7xl mx-auto py-12 px-4 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl lg:text-6xl">
                Misi: 30kg <span class="text-orange-600">&rarr;</span> 40kg
            </h1>
            <p class="mt-4 max-w-2xl mx-auto text-xl text-gray-500">
                Panduan Ectomorph Indonesia. Sekarang lebih pintar dengan <strong>Kecerdasan Buatan Gemini</strong>.
            </p>
            <div class="mt-6 flex justify-center gap-4">
                <a href="#ai-assistant" class="inline-block bg-purple-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-purple-700 transition transform hover:-translate-y-1">
                    ‚ú® Tanya Asisten AI
                </a>
                <a href="#kalori" class="inline-block bg-white text-green-600 border border-green-200 px-6 py-3 rounded-full font-bold shadow-sm hover:bg-green-50 transition">
                    ü•ó Cek Makanan
                </a>
            </div>
        </div>
    </header>

    <main class="space-y-16 pb-20">

        <!-- SECTION 0: AI ASSISTANT (NEW FEATURE) -->
        <section id="ai-assistant" class="pt-12 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-3xl p-1 border border-purple-100 shadow-xl">
                <div class="bg-white rounded-[20px] p-6 sm:p-8">
                    <div class="text-center mb-8">
                        <span class="inline-block py-1 px-3 rounded-full bg-purple-100 text-purple-600 text-xs font-bold tracking-wider uppercase mb-2">Powered by Gemini</span>
                        <h2 class="text-3xl font-extrabold text-gray-900">Asisten Pintar Ectomorph</h2>
                        <p class="text-gray-500 mt-2">Punya bahan sisa? Atau bingung kenapa berat badan nggak naik-naik? Tanya AI sekarang.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        <!-- FEATURE 1: CHEF AI -->
                        <div class="bg-white border-2 border-orange-100 rounded-2xl p-6 hover:border-orange-300 transition relative overflow-hidden group">
                            <div class="absolute top-0 right-0 bg-orange-100 text-orange-600 px-3 py-1 rounded-bl-xl text-xs font-bold">Resep Bulking</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">üë®‚Äçüç≥ Koki Kreatif</h3>
                            <p class="text-sm text-gray-500 mb-4">Masukkan bahan yang kamu punya di rumah (misal: "tempe, telur, kecap"), AI akan buatkan resep tinggi kalori.</p>
                            
                            <textarea id="recipe-ingredients" rows="2" placeholder="Contoh: Saya punya tempe, telur, dan nasi sisa. Tolong buatkan resep enak." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-orange-400 focus:border-transparent outline-none mb-3"></textarea>
                            
                            <button onclick="generateRecipe()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-xl flex items-center justify-center gap-2 transition shadow-md">
                                <span id="recipe-btn-text">‚ú® Buatkan Resep Ajaib</span>
                                <div id="recipe-loader" class="loader hidden"></div>
                            </button>

                            <div id="recipe-result" class="mt-4 hidden p-4 bg-orange-50 rounded-xl text-sm text-gray-700 prose max-w-none border border-orange-100 max-h-60 overflow-y-auto scroller"></div>
                        </div>

                        <!-- FEATURE 2: COACH AI -->
                        <div class="bg-white border-2 border-blue-100 rounded-2xl p-6 hover:border-blue-300 transition relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-blue-100 text-blue-600 px-3 py-1 rounded-bl-xl text-xs font-bold">Analisis Nutrisi</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">üìä Analisis Piring Saya</h3>
                            <p class="text-sm text-gray-500 mb-4">AI akan menganalisis daftar makanan di "Piring Hari Ini" (di bawah) dan memberi saran personal.</p>
                            
                            <div class="bg-blue-50 p-3 rounded-lg mb-4 text-xs text-blue-800">
                                <strong>Status Saat Ini:</strong><br>
                                <span id="ai-status-cal">0</span> kkal dikonsumsi.<br>
                                <span id="ai-status-items">0</span> jenis makanan dipilih.
                            </div>

                            <button onclick="analyzePlate()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-xl flex items-center justify-center gap-2 transition shadow-md">
                                <span id="analyze-btn-text">‚ú® Analisis Makanan Saya</span>
                                <div id="analyze-loader" class="loader hidden" style="border-top-color: white;"></div>
                            </button>

                            <div id="analyze-result" class="mt-4 hidden p-4 bg-blue-50 rounded-xl text-sm text-gray-700 prose max-w-none border border-blue-100 max-h-60 overflow-y-auto scroller"></div>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 1: TOOLS (Calculator & Tracker) -->
        <section id="tools" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-8">
                <h2 class="text-blue-600 font-bold tracking-wide uppercase text-sm">Langkah 1</h2>
                <h3 class="text-3xl font-extrabold text-gray-900">Hitung Target & Pantau Berat</h3>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Calculator -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                    <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">üî¢ Kalkulator Kebutuhan Kalori</h4>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Berat (kg)</label>
                                <input type="number" id="calc-weight" value="30" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Tinggi (cm)</label>
                                <input type="number" id="calc-height" value="165" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Umur</label>
                                <input type="number" id="calc-age" value="14" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Aktivitas</label>
                                <select id="calc-activity" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg">
                                    <option value="1.2">Jarang Olahraga</option>
                                    <option value="1.375" selected>Olahraga 3x/minggu</option>
                                    <option value="1.55">Olahraga 5x/minggu</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="calculateCalories()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition">Hitung Target Harian</button>
                        
                        <div id="calc-result" class="hidden mt-4 bg-blue-50 p-4 rounded-xl border border-blue-200 text-center">
                            <p class="text-sm text-blue-800">Targetmu untuk Naik Berat Badan:</p>
                            <p class="text-4xl font-extrabold text-blue-700 my-2"><span id="target-cal">2000</span> <span class="text-lg">kkal</span></p>
                            <p class="text-xs text-blue-600">Angka ini otomatis dipakai di fitur Cek Makanan di bawah.</p>
                        </div>
                    </div>
                </div>

                <!-- Weight Tracker -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 flex flex-col">
                    <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">üìà Grafik Progres BB</h4>
                    <div class="flex gap-2 mb-4">
                        <input type="date" id="tracker-date" class="flex-1 p-2 border rounded-lg text-sm">
                        <input type="number" id="tracker-weight" placeholder="BB (kg)" class="w-24 p-2 border rounded-lg text-sm">
                        <button onclick="addWeightLog()" class="bg-orange-500 text-white px-4 rounded-lg font-bold hover:bg-orange-600">+</button>
                    </div>
                    <div class="relative flex-grow h-48 w-full bg-gray-50 rounded-lg border border-gray-100 p-2">
                        <canvas id="weightChart"></canvas>
                    </div>
                    <button onclick="resetData()" class="text-xs text-red-400 mt-2 text-right hover:underline">Reset Grafik</button>
                </div>
            </div>
        </section>

        <!-- SECTION 2: FOOD CHECKER (Indonesian Database) -->
        <section id="kalori" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-3xl shadow-xl border border-green-100 overflow-hidden">
                <div class="bg-green-600 p-6 sm:p-10 text-white">
                    <h2 class="text-3xl font-extrabold mb-2">üçΩÔ∏è Cek Kalori Makanan Indonesia</h2>
                    <p class="text-green-100">Cari makananmu, tambahkan ke piring, dan lihat apakah kamu sudah surplus kalori hari ini.</p>
                    
                    <!-- Progress Bar -->
                    <div class="mt-8 bg-black/20 rounded-full p-1 backdrop-blur-sm">
                        <div class="flex justify-between text-xs font-bold px-2 mb-1">
                            <span>Konsumsi: <span id="eaten-val">0</span> kkal</span>
                            <span>Target: <span id="goal-val">--</span> kkal</span>
                        </div>
                        <div class="w-full bg-black/30 rounded-full h-4">
                            <div id="calorie-bar" class="bg-yellow-400 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div id="status-msg" class="text-center text-xs font-bold mt-2 text-yellow-300">‚ö†Ô∏è Hitung target kalori di atas dulu!</div>
                    </div>
                </div>

                <div class="p-6 sm:p-8 grid grid-cols-1 lg:grid-cols-5 gap-8">
                    
                    <!-- Search & List Area (3 cols) -->
                    <div class="lg:col-span-3 space-y-6">
                        <!-- Search Input -->
                        <div class="relative">
                            <input type="text" id="food-search" onkeyup="filterFood()" placeholder="Cari: Nasi Goreng, Telur, Tempe..." class="w-full pl-12 pr-4 py-4 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-0 text-lg shadow-sm">
                            <span class="absolute left-4 top-4 text-2xl">üîç</span>
                        </div>

                        <!-- Categories -->
                        <div class="flex flex-wrap gap-2">
                            <button onclick="filterCategory('all')" class="cat-btn px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-bold border border-green-200 active">Semua</button>
                            <button onclick="filterCategory('karbo')" class="cat-btn px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-sm font-medium hover:bg-gray-200">üçö Karbo</button>
                            <button onclick="filterCategory('lauk')" class="cat-btn px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-sm font-medium hover:bg-gray-200">üçó Lauk</button>
                            <button onclick="filterCategory('sayur')" class="cat-btn px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-sm font-medium hover:bg-gray-200">ü•¶ Sayur</button>
                            <button onclick="filterCategory('jajan')" class="cat-btn px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-sm font-medium hover:bg-gray-200">üç© Jajan/Minum</button>
                        </div>

                        <!-- Results List -->
                        <div id="food-list" class="h-96 overflow-y-auto scroller space-y-3 pr-2">
                            <!-- Populated by JS -->
                            <div class="text-center text-gray-400 mt-10">Ketik nama makanan di atas...</div>
                        </div>
                    </div>

                    <!-- Daily Plate (2 cols) -->
                    <div class="lg:col-span-2 bg-gray-50 rounded-2xl p-6 border border-gray-200 flex flex-col h-[600px] lg:h-auto">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between">
                            <span>üìù Piring Hari Ini</span>
                            <button onclick="clearPlate()" class="text-xs text-red-500 hover:text-red-700">Hapus Semua</button>
                        </h3>
                        
                        <div id="daily-log" class="flex-grow overflow-y-auto scroller space-y-2 mb-4">
                            <!-- Log Items go here -->
                            <div class="text-center text-gray-400 text-sm italic mt-10">Belum ada makanan.<br>Klik (+) pada daftar makanan.</div>
                        </div>

                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-gray-600">Total Kalori:</span>
                                <span class="text-2xl font-bold text-green-600" id="total-display">0</span>
                            </div>
                            <p class="text-xs text-gray-400 text-right">kkal</p>
                            <!-- Mini button to trigger AI from here too -->
                            <button onclick="document.getElementById('ai-assistant').scrollIntoView({behavior: 'smooth'});" class="w-full mt-2 text-xs text-purple-600 hover:text-purple-800 font-bold border border-purple-200 rounded py-1">‚ú® Analisis dengan AI</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: WORKOUT & TIMER -->
        <section id="latihan" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-gray-200 pb-4">
                <div>
                    <h2 class="text-3xl font-extrabold text-gray-900">üèãÔ∏è Zona Latihan</h2>
                    <p class="text-gray-500 mt-1">Gunakan beban 3kg. Teknik lambat lebih penting dari beban berat.</p>
                </div>
                <!-- Timer -->
                <div class="mt-4 md:mt-0 bg-gray-900 text-white p-3 rounded-xl shadow-lg flex items-center gap-4">
                    <div class="text-center">
                        <div class="text-[10px] text-gray-400 uppercase tracking-wider">Istirahat</div>
                        <div id="timer-display" class="text-2xl font-mono font-bold text-green-400">01:30</div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <button onclick="startTimer()" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-xs font-bold">Start</button>
                        <button onclick="resetTimer()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs font-bold">Reset</button>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                <button onclick="renderWorkout('A')" id="btn-plan-a" class="flex-shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-orange-600 text-white">Plan A (Senin/Jumat)</button>
                <button onclick="renderWorkout('B')" id="btn-plan-b" class="flex-shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-gray-200 text-gray-600 hover:bg-gray-300">Plan B (Rabu)</button>
            </div>

            <div id="workout-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Workout Cards JS -->
            </div>
        </section>

    </main>

    <footer class="bg-gray-900 text-white py-8 text-center">
        <p class="text-gray-400 text-sm">Ectomorph Guide V4 &copy; 2025</p>
        <p class="text-xs text-gray-600 mt-1">Data kalori adalah estimasi rata-rata makanan Indonesia.</p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 0. GEMINI API INTEGRATION ---
        const apiKey = ""; // Disuntikkan oleh sistem

        async function callGemini(prompt) {
            if (!apiKey) {
                alert("API Key tidak ditemukan. Fitur ini hanya bekerja di environment preview.");
                return "Error: API Key missing.";
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Maaf, sistem AI sedang sibuk. Coba lagi nanti.";
            }
        }

        // Feature 1: Recipe Generator
        async function generateRecipe() {
            const input = document.getElementById('recipe-ingredients').value;
            const btnText = document.getElementById('recipe-btn-text');
            const loader = document.getElementById('recipe-loader');
            const resultDiv = document.getElementById('recipe-result');

            if (!input.trim()) {
                alert("Masukkan bahan-bahan dulu ya!");
                return;
            }

            // UI State: Loading
            btnText.innerText = "Sedang Meracik...";
            loader.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            const prompt = `
                Berperanlah sebagai koki Indonesia yang ahli dalam gizi untuk orang kurus (ectomorph) yang ingin menambah berat badan.
                Pengguna memiliki bahan-bahan ini: "${input}".
                
                Tugasmu:
                1. Buatkan SATU resep masakan Indonesia yang lezat, murah, dan TINGGI KALORI menggunakan bahan tersebut.
                2. Berikan estimasi kalori per porsi.
                3. Gunakan bahasa Indonesia yang santai dan memotivasi.
                4. Format jawaban dengan Markdown (Bold untuk judul, list untuk langkah).
            `;

            const aiResponse = await callGemini(prompt);

            // UI State: Done
            btnText.innerText = "‚ú® Buatkan Resep Ajaib";
            loader.classList.add('hidden');
            resultDiv.innerHTML = marked.parse(aiResponse); // Parse Markdown
            resultDiv.classList.remove('hidden');
        }

        // Feature 2: Plate Analyzer
        async function analyzePlate() {
            const btnText = document.getElementById('analyze-btn-text');
            const loader = document.getElementById('analyze-loader');
            const resultDiv = document.getElementById('analyze-result');

            if (plate.length === 0) {
                alert("Piringmu masih kosong! Tambahkan makanan dulu di bagian bawah.");
                document.getElementById('kalori').scrollIntoView({behavior: 'smooth'});
                return;
            }

            // Prepare Data for Prompt
            const foodList = plate.map(item => `${item.name} (${item.cal} kkal)`).join(", ");
            const totalCals = consumedCalories;
            const target = targetCalories > 0 ? targetCalories : 2500; // Default if not calculated

            // UI State: Loading
            btnText.innerText = "Sedang Menganalisis...";
            loader.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            const prompt = `
                Berperanlah sebagai pelatih kebugaran dan ahli gizi pribadi untuk remaja Indonesia bertubuh kurus (Ectomorph).
                
                Data Makan Hari Ini:
                - Daftar Makanan: ${foodList}
                - Total Kalori Masuk: ${totalCals} kkal
                - Target Harian: ${target} kkal
                
                Tugasmu:
                1. Analisis apakah makanan ini sudah cukup untuk bulking?
                2. Apa yang kurang? (Protein? Karbo? Serat?)
                3. Berikan saran makanan tambahan murah yang mudah didapat di warung Indonesia untuk melengkapi kekurangan.
                4. Berikan kalimat motivasi singkat.
                5. Format jawaban dengan Markdown.
            `;

            const aiResponse = await callGemini(prompt);

            // UI State: Done
            btnText.innerText = "‚ú® Analisis Makanan Saya";
            loader.classList.add('hidden');
            resultDiv.innerHTML = marked.parse(aiResponse);
            resultDiv.classList.remove('hidden');
        }


        // --- 1. DATABASE MAKANAN INDONESIA (LENGKAP) ---
        const foodDB = [
            // KARBO UTAMA
            { id: 1, name: 'Nasi Putih', unit: '1 piring sedang (150g)', cal: 204, cat: 'karbo' },
            { id: 2, name: 'Nasi Putih (Porsi Besar)', unit: '1 piring penuh (250g)', cal: 350, cat: 'karbo' },
            { id: 3, name: 'Nasi Uduk Komplit', unit: '1 bungkus', cal: 450, cat: 'karbo' },
            { id: 4, name: 'Nasi Goreng Ayam', unit: '1 piring', cal: 500, cat: 'karbo' },
            { id: 5, name: 'Mie Instan (Goreng)', unit: '1 bungkus', cal: 380, cat: 'karbo' },
            { id: 6, name: 'Mie Instan (Kuah)', unit: '1 bungkus', cal: 350, cat: 'karbo' },
            { id: 7, name: 'Roti Tawar', unit: '1 lembar', cal: 80, cat: 'karbo' },
            { id: 8, name: 'Lontong Sayur', unit: '1 porsi', cal: 400, cat: 'karbo' },
            { id: 9, name: 'Bubur Ayam', unit: '1 mangkok', cal: 250, cat: 'karbo' },
            { id: 10, name: 'Ubi Rebus/Goreng', unit: '1 buah sedang', cal: 150, cat: 'karbo' },
            { id: 11, name: 'Singkong Goreng', unit: '1 potong', cal: 100, cat: 'karbo' },
            { id: 12, name: 'Kentang Goreng', unit: '1 porsi sedang', cal: 300, cat: 'karbo' },
            { id: 13, name: 'Ketoprak', unit: '1 piring', cal: 400, cat: 'karbo' },
            
            // LAUK PROTEIN
            { id: 20, name: 'Telur Rebus', unit: '1 butir besar', cal: 78, cat: 'lauk' },
            { id: 21, name: 'Telur Dadar/Ceplok (Minyak)', unit: '1 butir', cal: 110, cat: 'lauk' },
            { id: 22, name: 'Ayam Goreng (Paha/Dada)', unit: '1 potong', cal: 260, cat: 'lauk' },
            { id: 23, name: 'Ayam Bakar', unit: '1 potong', cal: 200, cat: 'lauk' },
            { id: 24, name: 'Sate Ayam', unit: '1 tusuk (bumbu kacang)', cal: 35, cat: 'lauk' },
            { id: 25, name: 'Tempe Goreng', unit: '1 potong sedang', cal: 80, cat: 'lauk' },
            { id: 26, name: 'Tempe Bacem', unit: '1 potong', cal: 90, cat: 'lauk' },
            { id: 27, name: 'Tahu Goreng', unit: '1 potong kotak', cal: 60, cat: 'lauk' },
            { id: 28, name: 'Ikan Lele Goreng', unit: '1 ekor', cal: 200, cat: 'lauk' },
            { id: 29, name: 'Bakso Sapi', unit: '1 butir sedang', cal: 50, cat: 'lauk' },
            { id: 30, name: 'Rendang Daging', unit: '1 potong', cal: 250, cat: 'lauk' },
            { id: 31, name: 'Ikan Mas Goreng', unit: '1 ekor sedang', cal: 250, cat: 'lauk' },

            // SAYUR & BUAH
            { id: 40, name: 'Sayur Asem', unit: '1 mangkok', cal: 80, cat: 'sayur' },
            { id: 41, name: 'Sayur Bayam Bening', unit: '1 mangkok', cal: 50, cat: 'sayur' },
            { id: 42, name: 'Tumis Kangkung', unit: '1 porsi', cal: 120, cat: 'sayur' },
            { id: 43, name: 'Capcay', unit: '1 porsi', cal: 150, cat: 'sayur' },
            { id: 44, name: 'Gado-gado (Komplit)', unit: '1 piring', cal: 450, cat: 'sayur' },
            { id: 45, name: 'Pisang Ambon', unit: '1 buah', cal: 105, cat: 'sayur' },
            { id: 46, name: 'Alpukat', unit: '1 buah sedang', cal: 320, cat: 'sayur' },
            { id: 47, name: 'Pepaya', unit: '1 potong panjang', cal: 60, cat: 'sayur' },
            { id: 48, name: 'Lalapan (Timun/Kol)', unit: '1 porsi', cal: 20, cat: 'sayur' },

            // JAJANAN & MINUMAN
            { id: 60, name: 'Gorengan (Bakwan/Mendoan)', unit: '1 buah', cal: 140, cat: 'jajan' },
            { id: 61, name: 'Martabak Manis/Terang Bulan', unit: '1 potong', cal: 300, cat: 'jajan' },
            { id: 62, name: 'Susu Full Cream', unit: '1 gelas (250ml)', cal: 150, cat: 'jajan' },
            { id: 63, name: 'Es Teh Manis', unit: '1 gelas', cal: 90, cat: 'jajan' },
            { id: 64, name: 'Kopi Susu Gula Aren', unit: '1 cup', cal: 180, cat: 'jajan' },
            { id: 65, name: 'Kerupuk Putih (Kaleng)', unit: '1 buah', cal: 65, cat: 'jajan' },
            { id: 66, name: 'Seblak Komplit', unit: '1 mangkok', cal: 450, cat: 'jajan' },
            { id: 67, name: 'Bubur Kacang Hijau (Santan)', unit: '1 mangkok', cal: 300, cat: 'jajan' },
            { id: 68, name: 'Cilor/Cimol', unit: '1 porsi (plastik)', cal: 250, cat: 'jajan' }
        ];

        let targetCalories = 0;
        let consumedCalories = 0;
        let plate = [];

        // --- 2. LOGIC CEK MAKANAN ---
        function renderFoodList(items) {
            const container = document.getElementById('food-list');
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">Makanan tidak ditemukan. Coba kata kunci lain.</div>';
                return;
            }

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 hover:border-green-400 cursor-pointer transition shadow-sm';
                
                // Icon based on category
                let icon = 'üçΩÔ∏è';
                if(item.cat === 'karbo') icon = 'üçö';
                if(item.cat === 'lauk') icon = 'üçó';
                if(item.cat === 'sayur') icon = 'ü•¶';
                if(item.cat === 'jajan') icon = 'üç©';

                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl bg-gray-50 p-2 rounded-lg">${icon}</span>
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${item.name}</div>
                            <div class="text-xs text-gray-500">${item.unit}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-green-600">${item.cal} kkal</span>
                        <button onclick="addToPlate(${item.id})" class="bg-green-100 hover:bg-green-200 text-green-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">+</button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function filterFood() {
            const query = document.getElementById('food-search').value.toLowerCase();
            const filtered = foodDB.filter(item => item.name.toLowerCase().includes(query));
            renderFoodList(filtered);
        }

        function filterCategory(cat) {
            // Update UI buttons
            const btns = document.querySelectorAll('.cat-btn');
            btns.forEach(b => {
                b.classList.remove('bg-green-100', 'text-green-700', 'border-green-200', 'active');
                b.classList.add('bg-gray-100', 'text-gray-600');
            });

            // Determine active button (Fix for window.onload vs click)
            let activeBtn = null;
            if (typeof event !== 'undefined' && event.type === 'click') {
                activeBtn = event.target;
            } else {
                // Find button by category if not triggered by click event
                activeBtn = Array.from(btns).find(b => b.getAttribute('onclick').includes(`'${cat}'`));
            }

            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
                activeBtn.classList.add('bg-green-100', 'text-green-700', 'border-green-200', 'active');
            }

            // Filter logic (Safe check for input existence)
            const searchInput = document.getElementById('food-search');
            const query = searchInput ? searchInput.value.toLowerCase() : '';
            
            let filtered = foodDB.filter(item => item.name.toLowerCase().includes(query));
            
            if (cat !== 'all') {
                filtered = filtered.filter(item => item.cat === cat);
            }
            renderFoodList(filtered);
        }

        function addToPlate(id) {
            const item = foodDB.find(f => f.id === id);
            plate.push({ ...item, instanceId: Date.now() });
            updatePlateUI();
        }

        function removeFromPlate(instanceId) {
            plate = plate.filter(p => p.instanceId !== instanceId);
            updatePlateUI();
        }

        function clearPlate() {
            plate = [];
            updatePlateUI();
        }

        function updatePlateUI() {
            const container = document.getElementById('daily-log');
            const totalDisplay = document.getElementById('total-display');
            const eatenDisplay = document.getElementById('eaten-val');
            
            // AI Status Update
            document.getElementById('ai-status-cal').innerText = consumedCalories;
            document.getElementById('ai-status-items').innerText = plate.length;
            
            container.innerHTML = '';
            consumedCalories = 0;

            plate.forEach(item => {
                consumedCalories += item.cal;
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-white p-2 rounded-lg border border-gray-100 text-sm';
                el.innerHTML = `
                    <div class="truncate w-32 font-medium text-gray-700">${item.name}</div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">${item.cal}</span>
                        <button onclick="removeFromPlate(${item.instanceId})" class="text-red-400 hover:text-red-600 font-bold px-1">√ó</button>
                    </div>
                `;
                container.appendChild(el);
            });

            totalDisplay.innerText = consumedCalories;
            eatenDisplay.innerText = consumedCalories;
            
            // AI Status Update again after calc
            document.getElementById('ai-status-cal').innerText = consumedCalories;

            updateProgressBar();
        }

        function updateProgressBar() {
            const bar = document.getElementById('calorie-bar');
            const status = document.getElementById('status-msg');
            
            if (targetCalories === 0) {
                bar.style.width = '0%';
                status.innerText = '‚ö†Ô∏è Hitung target kalori di atas dulu!';
                return;
            }

            const pct = Math.min((consumedCalories / targetCalories) * 100, 100);
            bar.style.width = `${pct}%`;

            if (pct < 50) {
                bar.className = 'bg-red-400 h-4 rounded-full transition-all duration-500';
                status.innerText = 'Masih kurang banyak! Makan lagi.';
                status.className = 'text-center text-xs font-bold mt-2 text-red-200';
            } else if (pct < 90) {
                bar.className = 'bg-yellow-400 h-4 rounded-full transition-all duration-500';
                status.innerText = 'Dikit lagi! Semangat.';
                status.className = 'text-center text-xs font-bold mt-2 text-yellow-200';
            } else {
                bar.className = 'bg-green-400 h-4 rounded-full transition-all duration-500';
                status.innerText = 'üéâ Target Surplus Tercapai! Mantap.';
                status.className = 'text-center text-xs font-bold mt-2 text-green-200';
            }
        }

        // --- 3. CALCULATOR LOGIC ---
        function calculateCalories() {
            const weight = parseFloat(document.getElementById('calc-weight').value);
            const height = parseFloat(document.getElementById('calc-height').value);
            const age = parseFloat(document.getElementById('calc-age').value);
            const activity = parseFloat(document.getElementById('calc-activity').value);

            // BMR (Mifflin-St Jeor)
            let bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            // Target Bulking (+500 surplus)
            targetCalories = Math.round((bmr * activity) + 500);

            document.getElementById('calc-result').classList.remove('hidden');
            document.getElementById('target-cal').innerText = targetCalories;
            document.getElementById('goal-val').innerText = targetCalories;
            
            updateProgressBar();
            // Scroll to food checker smoothly
            document.getElementById('kalori').scrollIntoView({ behavior: 'smooth' });
        }

        // --- 4. WORKOUT RENDERER ---
        const workouts = {
            'A': [
                { name: 'Goblet Squat (Paha)', sets: '3 set x 12 reps', icon: 'ü¶µ' },
                { name: 'Push Up / Floor Press (Dada)', sets: '3 set x Failure', icon: 'üí™' },
                { name: 'Dumbbell Row (Punggung)', sets: '3 set x 12 reps', icon: 'üîô' },
                { name: 'Overhead Press (Bahu)', sets: '3 set x 10 reps', icon: 'üèãÔ∏è' }
            ],
            'B': [
                { name: 'Lunges (Kaki)', sets: '3 set x 10/kaki', icon: 'ü¶µ' },
                { name: 'Deadlift Dumbbell (Punggung)', sets: '3 set x 12 reps', icon: 'üèãÔ∏è' },
                { name: 'Lateral Raise (Bahu)', sets: '3 set x 10 reps', icon: 'üëê' },
                { name: 'Calf Raise (Betis)', sets: '3 set x 20 reps', icon: 'ü¶∂' }
            ]
        };

        function renderWorkout(plan) {
            const container = document.getElementById('workout-content');
            container.innerHTML = '';
            
            // Toggle Button Styles
            const btnA = document.getElementById('btn-plan-a');
            const btnB = document.getElementById('btn-plan-b');
            if(plan === 'A') {
                btnA.className = 'flex-shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-orange-600 text-white';
                btnB.className = 'flex-shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-gray-200 text-gray-600 hover:bg-gray-300';
            } else {
                btnB.className = 'flex-shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-orange-600 text-white';
                btnA.className = 'flex-shrink-0 px-5 py-2 rounded-full text-sm font-bold bg-gray-200 text-gray-600 hover:bg-gray-300';
            }

            workouts[plan].forEach((w, i) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4';
                card.innerHTML = `
                    <div class="bg-orange-50 w-12 h-12 rounded-full flex items-center justify-center text-2xl">${w.icon}</div>
                    <div>
                        <div class="font-bold text-gray-800">${w.name}</div>
                        <div class="text-sm text-orange-600 font-mono">${w.sets}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 5. TRACKER & TIMER (Helper Functions) ---
        // Weight Tracker Init
        let weightChart;
        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Start'],
                    datasets: [{
                        label: 'Berat (kg)',
                        data: [30],
                        borderColor: '#F97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function addWeightLog() {
            const w = document.getElementById('tracker-weight').value;
            const d = document.getElementById('tracker-date').value;
            if(w && d) {
                weightChart.data.labels.push(d);
                weightChart.data.datasets[0].data.push(w);
                weightChart.update();
            }
        }
        function resetData() {
            if(confirm('Reset grafik?')) {
                weightChart.data.labels = ['Start'];
                weightChart.data.datasets[0].data = [30];
                weightChart.update();
            }
        }

        // Timer Logic
        let timerInt;
        let time = 90;
        function startTimer() {
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                time--;
                if(time < 0) { clearInterval(timerInt); alert('Waktu Habis!'); resetTimer(); return; }
                const m = Math.floor(time/60).toString().padStart(2,'0');
                const s = (time%60).toString().padStart(2,'0');
                document.getElementById('timer-display').innerText = `${m}:${s}`;
            }, 1000);
        }
        function resetTimer() {
            clearInterval(timerInt);
            time = 90;
            document.getElementById('timer-display').innerText = "01:30";
        }

        // --- INIT ---
        window.onload = function() {
            // Load initial Food List
            filterCategory('all');
            // Init Chart
            initChart();
            // Init Workout
            renderWorkout('A');
            // Set date to today
            document.getElementById('tracker-date').valueAsDate = new Date();
        };

    </script>
</body>
    </html>
