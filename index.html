<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EctoGuide V17: Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 700: '#c2410c' },
                    },
                    boxShadow: { 'up': '0 -4px 6px -1px rgba(0, 0, 0, 0.05)' }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 16px 16px;
            padding-bottom: 100px;
            overflow-x: hidden;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(241, 245, 249, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-radius: 1.25rem;
        }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #f97316; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-btn.active { color: #f97316; }
        .nav-btn.active i { transform: scale(1.1); transition: all 0.2s; }
        .app-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .app-section.active-section { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .workout-check {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center; color: transparent; transition: all 0.2s;
        }
        .workout-check.done { background-color: #22c55e; border-color: #22c55e; color: white; }

        /* TOAST FIX */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px;
        }
        .toast-item {
            background-color: #1e293b; color: white; padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 10px;
            font-size: 0.875rem; font-weight: 600; animation: slideDown 0.3s ease-out;
        }
        .toast-item.error { background-color: #ef4444; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="text-slate-700 font-sans md:max-w-md md:mx-auto md:shadow-2xl md:min-h-screen md:bg-white">

    <!-- HEADER -->
    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md pt-6 pb-4 px-6 flex justify-between items-center border-b border-slate-100">
        <div>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider" id="header-subtitle">Halo Pejuang,</p>
            <h1 class="text-2xl font-extrabold text-slate-800 leading-tight" id="header-title">EctoGuide V17</h1>
        </div>
        <!-- FITUR BARU: STREAK COUNTER -->
        <div class="flex items-center gap-2 bg-orange-50 px-3 py-1.5 rounded-full border border-orange-100 shadow-sm">
            <i class="fas fa-fire text-orange-500 animate-pulse"></i>
            <span class="text-sm font-bold text-orange-700" id="streak-count">1</span>
            <span class="text-[10px] text-orange-400 font-bold">Hari</span>
        </div>
    </header>

    <main class="p-5 space-y-6">

        <!-- ================= 1. JADWAL & PRINSIP (HOME) ================= -->
        <section id="home-section" class="app-section active-section space-y-6">
            
            <!-- Summary Card -->
            <div class="glass-card p-5 bg-gradient-to-br from-brand-500 to-orange-600 text-white relative overflow-hidden">
                <i class="fas fa-bolt absolute -right-4 -bottom-4 text-8xl opacity-10 rotate-12"></i>
                <div class="relative z-10">
                    <h3 class="font-bold text-lg">Status Hari Ini</h3>
                    <div class="mt-4 flex justify-between items-end">
                        <div>
                            <p class="text-brand-100 text-xs uppercase">Target Kalori</p>
                            <p class="text-2xl font-bold"><span id="dash-cal">0</span> <span class="text-sm font-normal">/ <span id="dash-target">--</span></span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-brand-100 text-xs uppercase">Berat Badan</p>
                            <p class="text-2xl font-bold"><span id="dash-weight">--</span> <span class="text-sm font-normal">kg</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grafik Energi -->
            <div class="glass-card p-4 bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-sm text-slate-700">Manajemen Energi</h3>
                    <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500">Mingguan</span>
                </div>
                <div class="h-40 w-full relative"><canvas id="energyChart"></canvas></div>
            </div>

            <!-- Detail Harian -->
            <div class="glass-card p-4 bg-white">
                <h3 class="font-bold text-sm text-slate-700 mb-3">Detail Harian</h3>
                <div class="flex gap-2 overflow-x-auto hide-scroll pb-2 mb-3" id="day-buttons"></div>
                <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 transition-all" id="daily-card">
                    <h4 class="font-bold text-brand-700 text-lg mb-1" id="day-title">Senin</h4>
                    <p class="font-bold text-slate-800" id="day-activity">Latihan A</p>
                    <p class="text-sm text-slate-500 mt-2 leading-relaxed" id="day-desc">...</p>
                </div>
            </div>

            <!-- PRINSIP PENTING (GAMBAR v15) -->
            <div class="space-y-3">
                <h2 class="text-lg font-bold text-slate-800">Prinsip Penting</h2>
                
                <div class="glass-card p-4 bg-white relative overflow-hidden flex gap-4 items-start">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-500"></div>
                    <div class="text-2xl mt-1"><i class="fas fa-battery-full text-green-500"></i></div>
                    <div><h4 class="font-bold text-slate-800 text-sm">Hemat Energi</h4><p class="text-xs text-slate-500 mt-1 leading-relaxed">Jangan lari jauh/main bola berjam-jam. Simpan kalori.</p></div>
                </div>

                <div class="glass-card p-4 bg-white relative overflow-hidden flex gap-4 items-start">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-green-500"></div>
                    <div class="text-2xl mt-1">üç≤</div>
                    <div><h4 class="font-bold text-slate-800 text-sm">Surplus Kalori</h4><p class="text-xs text-slate-500 mt-1 leading-relaxed">Makan LEBIH dari yang kamu bakar.</p></div>
                </div>

                <div class="glass-card p-4 bg-white relative overflow-hidden flex gap-4 items-start">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-purple-500"></div>
                    <div class="text-2xl mt-1"><i class="fas fa-stopwatch text-slate-400"></i></div>
                    <div><h4 class="font-bold text-slate-800 text-sm">Tempo Pelan</h4><p class="text-xs text-slate-500 mt-1 leading-relaxed">Angkat beban pelan (4 detik turun).</p></div>
                </div>

                <div class="glass-card p-4 bg-white relative overflow-hidden flex gap-4 items-start">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-red-500"></div>
                    <div class="text-2xl mt-1"><i class="fas fa-bed text-blue-400"></i></div>
                    <div><h4 class="font-bold text-slate-800 text-sm">Tidur = Tumbuh</h4><p class="text-xs text-slate-500 mt-1 leading-relaxed">Otot HANYA tumbuh saat tidur 8 jam.</p></div>
                </div>
            </div>
        </section>


        <!-- ================= 2. LATIHAN (WORKOUT + CUSTOM) ================= -->
        <section id="workout-section" class="app-section space-y-5">
            
            <!-- REST TIMER -->
            <div class="bg-slate-800 text-white p-4 rounded-2xl sticky top-[80px] z-30 shadow-lg flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Istirahat Antar Set</p>
                    <div id="timer-display" class="text-3xl font-mono font-bold text-brand-500">00:00</div>
                </div>
                <div class="flex flex-col gap-1">
                    <div class="flex gap-1">
                        <button onclick="startTimer(60)" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs font-bold transition">60s</button>
                        <button onclick="startTimer(90)" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs font-bold transition">90s</button>
                    </div>
                    <button onclick="stopTimer()" class="bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white px-3 py-1 rounded text-[10px] font-bold transition">Stop</button>
                </div>
            </div>

            <!-- Selector Plan -->
            <div class="flex bg-slate-100 p-1 rounded-2xl overflow-x-auto">
                <button onclick="renderWorkout('A')" id="btn-a" class="flex-1 py-2.5 px-3 rounded-xl font-bold text-xs whitespace-nowrap transition-all bg-white text-brand-600 shadow-sm">Plan A</button>
                <button onclick="renderWorkout('B')" id="btn-b" class="flex-1 py-2.5 px-3 rounded-xl font-bold text-xs whitespace-nowrap text-slate-500 hover:bg-white/50">Plan B</button>
                <button onclick="renderWorkout('C')" id="btn-c" class="flex-1 py-2.5 px-3 rounded-xl font-bold text-xs whitespace-nowrap text-slate-500 hover:bg-white/50">Plan C</button>
                <button onclick="renderWorkout('D')" id="btn-d" class="flex-1 py-2.5 px-3 rounded-xl font-bold text-xs whitespace-nowrap text-slate-500 hover:bg-white/50"><i class="fas fa-plus-circle mr-1"></i>Custom</button>
            </div>

            <!-- Area untuk Plan D (Custom) -->
            <div id="custom-workout-area" class="hidden">
                <div class="glass-card p-4 bg-orange-50 border border-orange-200 mb-4">
                    <h3 class="font-bold text-brand-700 mb-3 text-sm">Tambah Gerakan Baru</h3>
                    <div class="space-y-3">
                        <input id="cw-name" type="text" placeholder="Nama Gerakan (cth: Pull Up)" class="w-full p-2 rounded-lg border text-sm">
                        <div class="flex gap-2">
                            <input id="cw-sets" type="text" placeholder="Set (cth: 3 Set)" class="w-1/2 p-2 rounded-lg border text-sm">
                            <input id="cw-reps" type="text" placeholder="Reps (cth: 12 Reps)" class="w-1/2 p-2 rounded-lg border text-sm">
                        </div>
                        <textarea id="cw-desc" placeholder="Cara Melakukan..." class="w-full p-2 rounded-lg border text-sm h-20"></textarea>
                        <button onclick="addCustomWorkout()" class="w-full bg-brand-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-brand-700">Simpan Gerakan</button>
                    </div>
                </div>
            </div>

            <div id="arm-tip" class="hidden bg-orange-50 border border-orange-200 p-3 rounded-xl flex gap-3 items-start">
                <i class="fas fa-lightbulb text-brand-500 mt-1"></i>
                <div><h4 class="font-bold text-brand-700 text-xs">Tips Lengan</h4><p class="text-[10px] text-slate-600">Latih Tricep & Forearm.</p></div>
            </div>

            <div id="workout-container" class="space-y-3"></div>
        </section>


        <!-- ================= 3. MAKANAN (INPUT FIXED & AI) ================= -->
        <section id="food-section" class="app-section space-y-5">
            <div class="glass-card p-5 bg-white sticky top-[80px] z-30">
                 <div class="flex justify-between items-end mb-3">
                        <div>
                            <p class="text-xs text-slate-400 font-bold uppercase">Harian</p>
                            <h2 class="text-xl font-bold"><span id="total-cal-page" class="text-brand-600">0</span> / <span id="target-display">--</span> kkal</h2>
                        </div>
                        <button onclick="resetPlate()" class="text-xs text-slate-400 hover:text-red-500"><i class="fas fa-trash-alt mr-1"></i> Reset</button>
                    </div>
                    <div class="bg-slate-100 rounded-full h-3 w-full overflow-hidden">
                        <div id="progress-bar" class="bg-brand-500 h-full rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                    </div>
            </div>

            <div class="glass-card p-4 bg-blue-50 border border-blue-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fas fa-tint text-blue-500 text-xl"></i>
                    <div><h4 class="text-sm font-bold text-blue-800">Air Minum</h4><p class="text-[10px] text-blue-600">Otot butuh air.</p></div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-lg font-bold text-blue-700"><span id="water-count">0</span> Gelas</span>
                    <button onclick="addWater()" class="bg-blue-500 text-white w-8 h-8 rounded-full shadow hover:bg-blue-600">+</button>
                </div>
            </div>

            <div class="space-y-3">
                <div class="relative group">
                    <input type="text" id="food-search" placeholder="Cari: Nasi, Ayam..." class="w-full pl-4 pr-24 py-3 rounded-2xl bg-white border border-slate-200 outline-none text-sm shadow-sm">
                    <button onclick="searchWithAI()" id="ai-btn" class="absolute right-1 top-1 bottom-1 bg-slate-800 text-white px-3 rounded-xl text-xs font-bold flex items-center gap-1">
                        <i class="fas fa-magic text-brand-300"></i> Cari AI
                    </button>
                </div>
                <div id="ai-loading" class="hidden text-xs text-brand-600 ml-2"><div class="loader inline-block w-3 h-3 mr-1"></div> Mencari...</div>
                
                <button onclick="document.getElementById('manual-form').classList.toggle('hidden')" class="text-xs text-brand-600 font-bold underline ml-2">Input Manual</button>
                
                <!-- FIX INPUT MANUAL (LEBIH LEGA & RAPI) -->
                <div id="manual-form" class="hidden bg-white p-4 rounded-xl border border-slate-100 shadow-sm animate-fade-in-down">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Tambah Makanan Sendiri</h4>
                    <div class="space-y-3">
                        <input id="man-name" type="text" placeholder="Nama Makanan (cth: Bakso)" class="w-full p-3 rounded-lg border border-slate-200 bg-slate-50 text-sm focus:bg-white focus:border-brand-500 outline-none transition">
                        <div class="flex gap-2">
                            <input id="man-cal" type="number" placeholder="Kalori (kkal)" class="w-full p-3 rounded-lg border border-slate-200 bg-slate-50 text-sm focus:bg-white focus:border-brand-500 outline-none transition">
                            <button onclick="addManual()" class="bg-brand-600 text-white px-6 rounded-lg font-bold text-sm shadow-lg hover:bg-brand-700 transition">Simpan</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="my-plate" class="space-y-2 pb-4 border-b border-slate-100"></div>
            <div>
                <h3 class="font-bold text-slate-400 text-xs uppercase mb-2">Database Offline</h3>
                <div id="food-list" class="h-48 overflow-y-auto scroller space-y-2 pr-1"></div>
            </div>
        </section>


        <!-- ================= 4. PROGRESS ================= -->
        <section id="progress-section" class="app-section space-y-6">
            <div class="glass-card p-5 bg-white">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-calculator text-slate-400"></i> Pengaturan Target
                </h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Berat (kg)</label>
                            <input id="bb" type="number" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:bg-white outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Tinggi (cm)</label>
                            <input id="tb" type="number" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:bg-white outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Umur (thn)</label>
                            <input id="age" type="number" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:bg-white outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Gender</label>
                            <select id="gender" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:bg-white outline-none">
                                <option value="male">Pria</option>
                                <option value="female">Wanita</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Tingkat Aktivitas</label>
                        <select id="act" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:bg-white outline-none">
                            <option value="1.2">Rebahan (Sedentary)</option>
                            <option value="1.375">Ringan (Olah raga 1-3 hari)</option>
                            <option value="1.55">Sedang (Olah raga 3-5 hari)</option>
                            <option value="1.725">Berat (Olah raga 6-7 hari)</option>
                            <option value="1.9">Ekstrem (Atlet)</option>
                        </select>
                    </div>
                    <button onclick="calculateTarget()" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold text-sm hover:bg-slate-700 transition shadow-md flex justify-center items-center gap-2">
                        <i class="fas fa-save"></i> Hitung & Simpan Target
                    </button>
                    <div id="target-result" class="hidden bg-green-50 p-3 rounded-xl border border-green-200 text-center animate-bounce">
                        <p class="text-xs text-green-800">Target Harian Baru:</p>
                        <p class="text-2xl font-extrabold text-green-600" id="result-cal">0 kkal</p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-5 bg-white">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-chart-line text-brand-500"></i> Grafik BB</h3>
                <div class="flex gap-2 mb-3">
                    <input id="chart-date" type="date" class="bg-slate-50 border rounded-lg text-xs p-2 flex-1">
                    <input id="chart-weight" type="number" placeholder="kg" class="bg-slate-50 border rounded-lg text-xs p-2 w-16 text-center">
                    <button onclick="addWeightEntry()" class="bg-brand-600 text-white w-10 rounded-lg text-xs font-bold">+</button>
                </div>
                <div class="w-full h-48 relative"><canvas id="weightChart"></canvas></div>
            </div>
        </section>

    </main>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-100 shadow-up px-4 py-2 z-50 md:max-w-md md:mx-auto">
        <div class="flex justify-between items-center">
            <button onclick="switchTab('home')" class="nav-btn active flex flex-col items-center justify-center w-16 p-1 text-slate-400">
                <i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">Jadwal</span>
            </button>
            <button onclick="switchTab('workout')" class="nav-btn flex flex-col items-center justify-center w-16 p-1 text-slate-400">
                <i class="fas fa-dumbbell text-xl mb-1"></i><span class="text-[10px] font-bold">Latihan</span>
            </button>
            <div class="relative -top-6">
                <button onclick="switchTab('food')" class="nav-btn flex items-center justify-center w-14 h-14 bg-brand-600 text-white rounded-full shadow-lg border-4 border-white transform active:scale-95 transition">
                    <i class="fas fa-utensils text-xl"></i>
                </button>
            </div>
            <button onclick="switchTab('progress')" class="nav-btn flex flex-col items-center justify-center w-16 p-1 text-slate-400">
                <i class="fas fa-user-cog text-xl mb-1"></i><span class="text-[10px] font-bold">Profil</span>
            </button>
        </div>
    </nav>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIC JS -->
    <script>
        // === NAVIGASI ===
        function switchTab(tabName) {
            document.querySelectorAll('.app-section').forEach(sec => sec.classList.remove('active-section'));
            document.getElementById(`${tabName}-section`).classList.add('active-section');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const map = {'home':0, 'workout':1, 'food':2, 'progress':3};
            const btns = document.querySelectorAll('.nav-btn');
            if(tabName !== 'food') btns[map[tabName] > 1 ? map[tabName] : map[tabName]].classList.add('active');
            window.scrollTo(0,0);
        }

        // === STREAK COUNTER (NEW) ===
        function checkStreak() {
            const today = new Date().toDateString();
            let lastLogin = localStorage.getItem('lastLogin');
            let streak = parseInt(localStorage.getItem('streakCount')) || 1;

            if (lastLogin !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (lastLogin === yesterday.toDateString()) {
                    streak++;
                } else {
                    streak = 1; // Reset if broken
                }
                localStorage.setItem('lastLogin', today);
                localStorage.setItem('streakCount', streak);
            }
            document.getElementById('streak-count').innerText = streak;
        }

        // === 1. JADWAL (LAMA) ===
        const scheduleData = {
            'Sen': { act: 'Latihan A (Atas)', desc: 'Fokus intensitas tinggi.', color: '#ea580c' },
            'Sel': { act: 'Istirahat Total', desc: 'Waktunya otot tumbuh.', color: '#22c55e' },
            'Rab': { act: 'Latihan B (Bawah)', desc: 'Latihan Kaki.', color: '#ea580c' },
            'Kam': { act: 'Istirahat Total', desc: 'Simpan energimu.', color: '#22c55e' },
            'Jum': { act: 'Latihan C (Lengan)', desc: 'Spesial membesarkan lengan.', color: '#ea580c' },
            'Sab': { act: 'Istirahat Aktif', desc: 'Jalan santai.', color: '#eab308' },
            'Min': { act: 'Istirahat Total', desc: 'Persiapan.', color: '#22c55e' }
        };
        function initSchedule() {
            const ctx = document.getElementById('energyChart').getContext('2d');
            new Chart(ctx, { type: 'bar', data: { labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'], datasets: [{ label: 'Intensitas', data: [90, 20, 90, 20, 80, 40, 10], backgroundColor: ['#ea580c', '#22c55e', '#ea580c', '#22c55e', '#ea580c', '#eab308', '#22c55e'], borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } } });
            const btnContainer = document.getElementById('day-buttons');
            Object.keys(scheduleData).forEach((day, index) => {
                btnContainer.innerHTML += `<button onclick="updateDailyCard('${day}', this)" class="day-btn flex-shrink-0 w-10 h-10 rounded-xl text-xs font-bold border ${index===0 ? 'bg-brand-600 text-white border-brand-600 shadow-md' : 'bg-white text-slate-500 border-slate-200'} transition">${day}</button>`;
            });
        }
        function updateDailyCard(day, btnElement) {
            document.querySelectorAll('.day-btn').forEach(b => b.className = 'day-btn flex-shrink-0 w-10 h-10 rounded-xl text-xs font-bold border bg-white text-slate-500 border-slate-200 transition');
            btnElement.className = 'day-btn flex-shrink-0 w-10 h-10 rounded-xl text-xs font-bold border bg-brand-600 text-white border-brand-600 shadow-md transition';
            const data = scheduleData[day];
            document.getElementById('day-title').innerText = day; document.getElementById('day-activity').innerText = data.act; document.getElementById('day-desc').innerText = data.desc;
        }

        // === 2. LATIHAN (TIMER + CUSTOM) ===
        let timerInterval;
        function startTimer(seconds) {
            clearInterval(timerInterval);
            let timeLeft = seconds;
            const display = document.getElementById('timer-display');
            display.innerText = `00:${timeLeft}`;
            timerInterval = setInterval(() => {
                timeLeft--;
                display.innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                if (timeLeft <= 0) { clearInterval(timerInterval); alert("Istirahat Selesai!"); display.innerText = "00:00"; }
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); document.getElementById('timer-display').innerText = "00:00"; }

        let workouts = {
            'A': [{ n: 'Push Up', s: '3 Set x Max', d: 'Dada & Tricep.' }, { n: 'Dumbbell Row', s: '3 Set x 12', d: 'Punggung.' }, { n: 'Overhead Press', s: '3 Set x 10', d: 'Bahu.' }],
            'B': [{ n: 'Squat', s: '3 Set x 12', d: 'Paha.' }, { n: 'Lunges', s: '3 Set x 10', d: 'Kaki.' }],
            'C': [{ n: 'Diamond Push Up', s: '3 Set x 8', d: 'Tricep Fokus.' }, { n: 'Hammer Curl', s: '3 Set x 12', d: 'Lengan Samping.' }, { n: 'Wrist Curl', s: '3 Set x 20', d: 'Forearm.' }]
        };
        let customPlan = JSON.parse(localStorage.getItem('customWorkouts')) || [];

        function renderWorkout(plan) {
            ['a','b','c','d'].forEach(p => {
                const btn = document.getElementById(`btn-${p}`);
                if(p === plan.toLowerCase()) btn.className = "flex-1 py-2.5 px-3 rounded-xl font-bold text-xs whitespace-nowrap transition-all bg-white text-brand-600 shadow-sm border border-brand-100";
                else btn.className = "flex-1 py-2.5 px-3 rounded-xl font-bold text-xs whitespace-nowrap text-slate-500 hover:bg-white/50";
            });
            const cwArea = document.getElementById('custom-workout-area');
            const armTip = document.getElementById('arm-tip');
            
            if(plan === 'D') { cwArea.classList.remove('hidden'); armTip.classList.add('hidden'); renderWorkoutCards(customPlan, true); }
            else { cwArea.classList.add('hidden'); armTip.classList.toggle('hidden', plan !== 'C'); renderWorkoutCards(workouts[plan], false); }
        }

        function renderWorkoutCards(list, isCustom) {
            const c = document.getElementById('workout-container'); c.innerHTML = '';
            if(list.length === 0 && isCustom) { c.innerHTML = '<div class="text-center text-xs text-slate-400 italic p-4">Belum ada gerakan buatan sendiri.</div>'; return; }
            list.forEach((w, idx) => {
                let checks = ''; for(let i=0; i<3; i++) checks += `<div class="workout-check cursor-pointer" onclick="this.classList.toggle('done')"><i class="fas fa-check text-[10px]"></i></div>`;
                let deleteBtn = isCustom ? `<button onclick="deleteCustom(${idx})" class="text-red-400 text-[10px] ml-2 font-bold">Hapus</button>` : '';
                c.innerHTML += `<div class="glass-card bg-white p-4"><div class="flex justify-between items-start mb-2"><div><h4 class="font-bold text-slate-800">${w.n} ${deleteBtn}</h4><span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">${w.s}</span></div><button onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')" class="text-brand-500 text-xs font-bold bg-brand-50 px-2 py-1 rounded">Cara <i class="fas fa-chevron-down ml-1"></i></button></div><div class="hidden text-xs text-slate-600 bg-slate-50 p-2 mb-3 rounded border border-slate-100 leading-relaxed">${w.d}</div><div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-100"><span class="text-[10px] font-bold text-slate-400 uppercase">Set:</span><div class="flex gap-2">${checks}</div></div></div>`;
            });
        }

        function addCustomWorkout() {
            const n = document.getElementById('cw-name').value, s = document.getElementById('cw-sets').value, r = document.getElementById('cw-reps').value, d = document.getElementById('cw-desc').value;
            if(n && s && r && d) { customPlan.push({ n: n, s: `${s} x ${r}`, d: d }); localStorage.setItem('customWorkouts', JSON.stringify(customPlan)); renderWorkout('D'); showToast("Gerakan tersimpan!"); document.getElementById('cw-name').value=''; document.getElementById('cw-desc').value=''; } else { showToast("Isi semua kolom!", true); }
        }
        function deleteCustom(idx) { if(confirm('Hapus gerakan ini?')) { customPlan.splice(idx, 1); localStorage.setItem('customWorkouts', JSON.stringify(customPlan)); renderWorkout('D'); } }

        // === 3. MAKANAN & AIR ===
        const apiKey = "AIzaSyC7-7vIa8Fid87Z-NvCzeggVe7Iz5db_Zo";
        const localFoodDB = [{ name: 'Nasi Putih', cal: 204 }, { name: 'Telur Rebus', cal: 78 }, { name: 'Dada Ayam', cal: 165 }, { name: 'Mie Instan', cal: 380 }];
        let plate = JSON.parse(localStorage.getItem('plate')) || [];
        let targetCal = localStorage.getItem('targetCal') || 2500;
        let waterCount = localStorage.getItem('waterCount') || 0;

        async function searchWithAI() {
            const query = document.getElementById('food-search').value;
            if(!query) return showToast("Ketik nama makanan!", true);
            document.getElementById('ai-loading').classList.remove('hidden');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: `Estimasi kalori "${query}" JSON format: {"name": "Nama", "cal": 123}` }] }] }) });
                const data = await res.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                localFoodDB.unshift(result); renderFoodList(); showToast(`Ditemukan: ${result.name}`);
            } catch(e) { showToast("Gagal. Coba manual.", true); }
            document.getElementById('ai-loading').classList.add('hidden');
        }

        function renderFoodList() { const l = document.getElementById('food-list'); l.innerHTML = ''; localFoodDB.forEach(i => l.innerHTML += `<div onclick="addToPlate('${i.name}',${i.cal})" class="flex justify-between p-2 bg-white border border-slate-100 rounded-lg mb-2 cursor-pointer hover:border-brand-500"><span class="text-xs font-bold text-slate-700">${i.name}</span><span class="text-xs font-bold text-brand-600">${i.cal}</span></div>`); }
        function addToPlate(n,c){ plate.push({n,c,id:Date.now()}); updatePlate(); showToast("Masuk Piring!"); }
        function removeFromPlate(id){ plate = plate.filter(p=>p.id!==id); updatePlate(); }
        function resetPlate(){ if(confirm("Reset?")){ plate=[]; updatePlate(); } }
        
        // FIX INPUT MANUAL LOGIC
        function addManual(){ 
            const n = document.getElementById('man-name').value;
            const c = parseInt(document.getElementById('man-cal').value); 
            if(n && c){ 
                addToPlate(n, c); 
                document.getElementById('manual-form').classList.add('hidden');
                document.getElementById('man-name').value = '';
                document.getElementById('man-cal').value = '';
            } else {
                showToast("Isi nama & kalori!", true);
            }
        }
        
        function updatePlate() {
            const c = document.getElementById('my-plate'); c.innerHTML=''; let t=0;
            plate.forEach(p => { t+=p.c; c.innerHTML+=`<div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg text-xs"><span class="truncate w-32">${p.n}</span><div class="flex gap-2 font-bold"><span>${p.c}</span><span onclick="removeFromPlate(${p.id})" class="text-red-500 cursor-pointer">x</span></div></div>`; });
            document.getElementById('total-cal-page').innerText = t; document.getElementById('dash-cal').innerText = t;
            document.getElementById('dash-target').innerText = targetCal; document.getElementById('target-display').innerText = targetCal;
            document.getElementById('progress-bar').style.width = Math.min((t/targetCal)*100, 100)+'%';
            localStorage.setItem('plate', JSON.stringify(plate));
        }

        function addWater() {
            waterCount++;
            document.getElementById('water-count').innerText = waterCount;
            localStorage.setItem('waterCount', waterCount);
            showToast("+1 Gelas Air");
        }

        // === 4. KALKULATOR & GRAFIK ===
        function calculateTarget() {
            const bb = parseFloat(document.getElementById('bb').value);
            const tb = parseFloat(document.getElementById('tb').value);
            const age = parseFloat(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const act = parseFloat(document.getElementById('act').value);
            if(bb && tb && age && act) {
                let bmr = (10 * bb) + (6.25 * tb) - (5 * age);
                bmr += (gender === 'male') ? 5 : -161;
                targetCal = Math.round((bmr * act) + 500);
                localStorage.setItem('targetCal', targetCal);
                document.getElementById('result-cal').innerText = targetCal + " kkal";
                document.getElementById('target-result').classList.remove('hidden');
                updatePlate();
            } else { showToast("Isi semua data!", true); }
        }

        let chart;
        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const l = JSON.parse(localStorage.getItem('wLabels'))||[], d = JSON.parse(localStorage.getItem('wData'))||[];
            if(d.length) document.getElementById('dash-weight').innerText = d[d.length-1];
            chart = new Chart(ctx, { type:'line', data:{labels:l, datasets:[{data:d, borderColor:'#f97316', tension:0.4, fill:true, backgroundColor:'rgba(249,115,22,0.1)'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}}} });
        }
        function addWeightEntry(){ 
            const d=document.getElementById('chart-date').value, w=document.getElementById('chart-weight').value;
            if(d&&w){ chart.data.labels.push(d); chart.data.datasets[0].data.push(w); chart.update(); localStorage.setItem('wLabels',JSON.stringify(chart.data.labels)); localStorage.setItem('wData',JSON.stringify(chart.data.datasets[0].data)); document.getElementById('dash-weight').innerText=w; showToast("BB Disimpan!"); }
        }

        function showToast(msg, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-item ${isError ? 'error' : ''}`;
            toast.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'fadeOut 0.3s ease-out forwards'; setTimeout(() => { toast.remove(); }, 300); }, 3000);
        }

        window.onload = function() {
            checkStreak(); // Load Streak
            initSchedule(); renderFoodList(); renderWorkout('A'); updatePlate(); initChart();
            document.getElementById('chart-date').valueAsDate = new Date();
            document.getElementById('water-count').innerText = waterCount;
            switchTab('home');
        };
    </script>
</body>
</html>
